2012 지능형 모형차 경진대회
===================

Team Info
----------------

![](/img/2012_mie_pic2.jpg)

학교
: 서울시립대학교 기계정보공학과  

팀명
: M.I.E

팀원
: 허서영, 박진원, 박성훈, 권병수

수상
: 2012 지능형 모형차 경진대회 - 금상


개요
------------------

[지능형 모형차 경진대회](http://race.acelab.org)

#### 참가 배경
: 지능형 자동차 대회의 경우, 회로를 구성하기 위한 전자공학 관련 지식, 자동차의 안전한 주행을 위한 기계공학적 지식을 필요로 한다. 이 뿐만 아니라 선행 차량과의 간격을 유지하면서 주행하기 위한 알고리즘과 관련한 컴퓨터 공학적 지식 역시 필요하다. 우리 서울시립대 기계정보공학과의 경우 역학적 지식 뿐만 아니라 컴퓨터와 관련한 공부를 하고 있다. 이번 대회를 계기로 지금까지 배워온 전공지식을 기반으로 보다 효과적인 SCC(Smart Cruise Control)를 수행하는 차량을 제작해보고자 한다.

#### 설계 목표
: 설계목표는 Line Tracing을 수행하면서 주행 속도가 가변적인 선행 차량을 충돌 없이 최대한 좁은 간격을 유지하면서 안전한 주행을 하기 위한 효과적인 차량을 제작하는 것이다. 이와 동시에 이러한 목표를 수행하기 위해서는 Line Tracer를 수행하기 위한 적절한 알고리즘과 주행 속도가 가변적인 차량을 효과적으로 추적하는 알고리즘을 개발하는 또한 그 목표이다. 즉, 주어진 목표를 보다 효율적으로 수행하기 위한 적절한 차량 모델을 제작함과 동시에 이러한 차량을 효과적으로 제어하기 위한 알고리즘을 개발하는 것이 그 설계목표라 할 수 있다.  


하드웨어 구성
---------------------

#### **전체 구성**

중앙처리장치

* MCU : MC9S12XEP100
* Board : DEMO9S12XEP100  

전원부

* LM2576-5V (5V/3A Switching Regulator)
* LM7806CT (6V/1A Linear Regulator)

센서부

* 발광부 : SI5312-H
* 수광부 : SFH 300 FA-3/4
* 거리측정 : 초음파 센서 (SRF04)
* Encoder : E30S4-3000-3-V-5

조향부

* Servo Motor : HS-7940TH

구동부

* DC Motor : RS-540
* Motor Drive : IRF4905(P-MOS), IRF3205(N-MOS) 를 이용한 H-bridge 회로 설계

모형차

* VTX 독도 버기


#### **MCU 및 전원부**

##### 중앙처리장치

* MC9S12XEP100 MCU의 경우 기본적인 하나의 CISC core와 추가로 X-GATE라는 RISC core 가 함께 설계되어있는 Dual core MCU 이다.

* Softec 에서 제조한 DEMO9S12XEP100 Evaluation Board 의 경우 GPIO와 CAN, LIN 통신을 구현해 볼 수 있도록 Peripheral 이 구성되어있고 on-board BDM이 구성되어있어서 코드를 임베딩하기에 별도의 장비없이 USB만을 통해서 쉽게 할 수 있도록 구성되어있다.

##### 전원부

* LM2576-5V Regulator는 5V / 3A 의 전원을 공급해준다. 5V의 전원을 이용해서 LED, Switch, Segment, LCD, IR Emitter를 구동하기 위한 전원으로 사용했다. LM2576-5V Regulator는 Switching 방식의 Regulator로써 전압차이를 열로 발산시키는 Linear 방식의 Regulator 보다 발열이 적다는 장점을 가지고 있다. 하지만 Feedback 제어를 통해 출력을 제어   하기 때문에 출력되는 전원의 품질은 Linear 방식보다는 떨어진다.

* 7806 Regulator는 6V / 1A의 전원을 공급해준다. 6V의 전원은 조향을 위해서 사용하는 Servo Motor의 구동을 위한 전원으로 사용했다. Linear 방식의 Regulator로 발열이 크지만 Regulator에 방열판을 부착하여 열전달 면적을 높여 자연대류 현상을 증가시키도록 했다. 출력되는 전원의 품질이 우수하기 때문에 구동하는 Servo Motor의 전원으로 사용하여 Servo Motor를 제어하는데 발생할 수 있는 왜란을 최대한으로 줄이려 노력했다.

#### **센서부**

##### Line Search 센서부

* 적외선 센서를 사용하기 위해서 발광부와 수광부에 사용할 소자를 선정했다. 소자 선정을 위해서 여러 가지 조합의 발광부와 수광부의 조합을 실험해 보면서 가장 좋은 센서값이 얻어지는 조합을 찾아 결정했다.

* 발광부에 사용한 적외선 센서 소자는 AUK Semiconductor 사에서 만든 SI5312-H IR Emitter를 사용하였다. 출력되는 적외선 peak 파장은 950 [nm] 이고 최대 Emitting 각도는 +- 10˚ 이다.

* 수광부에 사용한 적외선 센서 소자는 OSRAM 사에서 만든 SFH 300 FA – 3/4 Photo Transistor 이다. 최대로 반응하는 적외선의 파장은 880 [nm] 이고 반응 각도는 약 +-30˚ 이다. 특히 물리적인 가시광선 필터가 구성되어있어서 수광부에서 얻어지는 센서값에 대해 왜란 요소를 최대한 줄이기 위해서 노력했다.

* 적외선 센서의 배치는 아래와 같이 몇 2.54 [cm] 간격으로 8조로 구성 했다. 대회에서 사용되는 라인의 간격이 2.5 [cm] 이기 때문에 2.54 [mm] pitch로 제작된 만능기판에 25.4 [mm] 간격으로 8 조로 배치하여 센서와 센서 사이에 라인이 위치했을 경우 Line Searching 알고리즘을 통해 중간 센서값을 얻어낼 수 있었다.

* 수광센서의 경우 저항과 커패시터를 이용해서 RC High Pass Filter를 구성하였다. Cutoff 주파수는 330Hz 가 되도록 구성하였다. 이유는 형광등의 점멸 주파수가 60 Hz 이기 때문에 이 빛의 영향을 최소로 하기 위함이다.

##### Smart Cruise Control 센서부

* 거리측정을 위해 SRF-04 초음파 센서를 사용했다. 초음파 센서 3개를 각각 전면과 좌․우에 배치했다. 초음파 센서의 경우 구면파를 통해 거리를 측정하게 되는데 1개만을 사용하여 선행차와의 거리를 측정할 경우 곡선 구간에서 선행차를 추적하지 못하는 문제가 발생했다. 따라서 전면과 약 25°기울여 좌․우에 배치하여 곡선 구간을 주행하는 경우에도 선행차를 놓치지 않도록 배치했다. 25°를 기울인 까닭은 SRF-04 초음파 센서의 Data sheet를 기반으로 정밀한 측정 범위가 좌․우 각각 25°이기 때문이다.   

#### **조향부**

##### Servo Motor

* Servo Motor는 Hitec 사의 HS-7940TH를 사용했다. 이 모델은 7.4V 에서 사용 가능하도록 설계되었고, 토크와 반응속도는16.0kg / 0.06sec @ 7.4V이다. 이 제품을 사용한 이유는 7.4V의 LiPo 배터리의 전원을 바로 사용할 수 있기 때문인데 6V용 regulator 회로를 구성할 필요가 없기 때문이다. 그리고 0.06sec의 빠른 반응속도를 가지고 있기 때문에 라인트레이서를 조향하는데 충분하다고 판단했기 때문이다.

* 기본적으로 제공되는 모형차의 Servo Horn은 C-ring 구조를 가지고 있어서 조향을 할 경우 급격한 조향에서 C-ring이 너무 쉽게 벌어져서 원하는 조향을 할 수 없었다. 그래서 C-ring겉에 케이블 타이를 이용해서 조여서 C-ring이 쉽게 벌어지는 현상을 방지하여 급격한 조향을 할 수 있도록 했다.

#### **구동부**

##### DC Motor

* RS-540 motor의 경우 Stall Current 가 약 70A정도로 전류를 많이 소모하는 모터이다. 따라서 대회에서 제공해주는 MC33887 모터 드라이브로는 DC motor 구동에 어려움이 있다라고 판단하여 P-MOSFET 과 N-MOSFET을 사용하여 H-Bridge 회로를 설계하여 사용했다.

##### Encoder

* SCC 차량에 Encoder를 장착하기 위해서 Rear 구동부의 Cap을 제거하고 위의 사진과 같이 Encoder를 장착하였다.

* Encoder의 경우 Autonics 사에서 나오는 3000 pulse / 5V 타입의 Encoder를 사용했다.

* Encoder에서 얻어지는 A, B 상의 pulse를 XOR GATE를 이용해서 2체배 회로를 구성하고 D-FilpFlop과 AND GATE를 이용하여 정방향 ․ 역방향의 펄스를 계측하고 이 값들의 차이로 최종 Encoder 펄스 값을 결정했다.

##### 모터 드라이브

* 4905(P-MOSFET), 3215(N-MOSFET) 을 이용하여 H-Bridge 회로를 설계하였는데 사용한 MOSFET의 최대 허용전류는 70A 이상인 모델을 사용하였다.

##### 2륜 구동

* 기본적으로 제공 받은 모형차(독도 버기)의 경우 오프로드용으로 판매되는 차량으로써 4륜 구동을 하도록 디자인 되어있다. 하지만 라인트레이서의 경우 4륜 구동 보다는 2륜 구동이 DC 모터의 부하를 조금이나마줄일 수 있으며 보다 빠른 Steering을 위해서는 2륜 구동방식이 효과적이기 때문에 2륜 구동 방식을 채택했다.

* 2륜 구동을 사용하기 위해서 front 구동부에 사용되는 베벨 기어만을 제거 하여 2륜 구동을 구현했다.

##### Shock Absorber

* Off-road 차량의 특성상 On-road 차량보다 Shock absorber의 수가 많이 구성되어있다. 특히 각각의 바퀴마다 Shock absorber 가 배치 되어있었다. 라인트레이서의 경우 라인을 찾는 센서부가 운행 중에 비교적 덜 좌/우로 기울어지게 하기 위해서 Shock absorber의 탄성을 증가시켰다. 탄성을 증가시키는 방법으로 차량부품 중에서 탄성 증가용으로 제작 되어진 부품을 추가하였으나 이것만으로는 부족해서 얇은 케이블 타이를 이용해 원하는 탄성력을 얻도록 구현했다.



소프트웨어 구성
-------------

#### **주행 알고리즘**

##### Line Searching 알고리즘

* Line을 검출하기 위해 발광부, 수광부 센서 각 1개를 1개 조로 구성, 2.56cm 간격으로8개조를 배치했다. 각 수광부에서 ADC Converting을 통해 들어오는 값을 Normalizing을 통해 0~100의 값으로 환산하고 센서부의 중심을 기준으로 Weight를 주어 Line Position을 구했다.

##### Smart Cruise Control 알고리즘

* 기본적으로 선행 차량과 SCC 차량의 목표 거리를 추적하는 PID Control을 사용했다. 여기서 P 제어에 이용되는 Error는 목표거리와 초음파 센서를 통해 받아들이는 선행차량과 SCC 차량의 거리의 차이이고, I 제어에는 이러한 Error의 합이 이용된다. D 제어에는 현재 Error와 과거 Error의 차가 이용되는데 이는 선행 차량과 SCC 차량의 상대속도가 된다. 마지막으로,  PID Control을 통해 나온 값과 SCC 차량의 속도를 더해 Smart Cruise Control 알고리즘을 구성했다. 이러한 PID 제어를 통해 나온 결과값을 통해 DC motor의 속도를 제어함으로써 Smart Cruise Control 알고리즘을 구현했다. 

* P Gain이 클 경우 시스템의 응답시간이 빨라지나 지나치게 클 경우 시스템을 불안정하게 하며, I Gain의 경우, 정상상태의 오차를 줄일 수 있으나 시스템의 반응속도를 느리게 하고 Overshoot를 발생시키는 단점이 있다. D Gain의 경우, Overshoot를 개선할 수 있으며, 응답속도를 빠르게 동작(Preact)시켜 제어 성능을 향상시킬 수 있으나 노이즈에 매우 민감하게 반응한다는 단점이 있다. 즉, 이러한 각각의 Gain이 가지는 특성을 잘 조절하여 원하는 제어를 수행할 수 있기 때문에 이를 적용하여 효과적인 제어를 수행했다. 각각의 Gain의 경우, 위에서 설명한 각 Gain의 특성을 기반으로 경험적 방법을 반복적으로 수행하여 구했다.

* 계산된 제어값이 실제 구동기가 작동할 수 있는 값의 한계보다 클 경우 포화가 발생하게 되는데 이를 Wind-up이라 한다. 이를 방지하기 위해 Programing처리를 해 적분항의 Error를 비워줌으로써 PID Control을 보완하도록 했다.

##### Servo motor 제어 알고리즘 

* 고속 주행에서 최소 곡률반경의 곡선 주행 구간을 통과하기 위한 Servo Motor의 효과적인 제어를 위해 PD Control을 구현했다. 

* 센서 값으로 결정된 line position 을 제어주기 당 하나씩 받아 5개의 값을 평균시켜 Line value를 결정한다. 다음에 들어오는 값은 이동 평균한다. 





주요 장치 이론 및 적용
----------------------------

#### **모터 드라이브**

##### H-Bridge 회로 설계

* MOS FET를 이용하여 H-Bridge를 아래의 회로도를 기반으로 구현했다. P-MOS FET 2개와 N-MOS FET 2개가 꺼지고 켜지는 상태에 따라 모터의 정방향과 역방향을 구현했다.

* 왼쪽 High Side와 오른쪽 Low Side의 MOS FET이 켜지면 모터에 +에서 –로 전류가 흐르게 되고, 오른쪽 High Side와 왼쪽 Low Side의 MOS FET이 켜지면 모터에 –에서 +로 전류가 흐르게 된다. 그리고 왼쪽 MOS FET이 동시에 켜지거나, 오른쪽 MOS FET이 동시에 켜지면 모터에는 전류가 흐르지 못하므로 모터는 멈추게 된다.

#### **Encoder 회로**

##### 2체배 회로

* 현재 장착된 Encoder의 경우 Resolution이 3000 pulses/rev이다. 보다 높은Resolution을 통해 정밀한 제어를 위해 아래와 같이 2체배 회로를 구현하였다. D-filpflop의 경우 입력된 두 pulse를 통해 방향을 판단하며 XOR GATE의 경우 Resolution을 2배로 만드는 역할을 수행한다. 오른쪽 아래 그림을 보면 Output A와 Output B의 pulse는 1/4 주기 차이가 발생하는 것을 알 수 있다. 이를 XOR GATE를 통해 연산을 거치면 펄스의 주기가 반으로 줄게 되고 6000 pulse/rev을 Resolution이 구현되는 것이라 이를 통해 보다 정밀하게 Motor를 제어할 수 있게 된다.



문제점
-----------------------

##### 주행 시 발생하는 SCC 차량의 좌우 흔들림

* SCC 차량이 Line Tracer를 수행하게 될 때 직선구간에서 좌우로 흔들리는 것을 확인할 수 있었다. 이는 SCC 차량이 직선구간에서 Line을 벗어날 경우 Servo motor가 조향을 틀기 때문에 발생하는 문제였다. 이러한 문제를 해결하기 위해 SCC 차량을 효과적으로 제어하기 위한 제어주기 구성을 최대한 짧게 함으로써 좌우 흔들림을 어느정도 보정할 수 있었다. 그러나 여전히 좌우 흔들림을 발생하는 것을 확인할 수 있었는데, 만약 SCC 차량에 직선 구간과 곡선 구간을 구분하는 적절한 알고리즘을 추가하여 직선 구간에서 Servo motor의 조향각을 줄인다면 보다 효과적으로 제어할 수 있을 것이다.

##### 주행 시 발생하는 진동으로 인한 초음파 센서의 흔들림

* 차량이 주행하게 됨으로써 진동이 발생하게 되는데 이러한 진동은 선행차량과의 거리를 측정하기 위한 초음파 센서까지 전달되어 초음파 센서가 흔들리는 현상이 발생하게 되었다. 이는 선행차량을 추적하는 데 문제를 야기할 수 있기 때문에 주행 중의 초음파 센서가 흔들리는 것을 최소화하기 위해 초음파 센서부를 따로 구성하고 Bar 3개를 이용하여 SCC 차량에 부착하였다. 이러한 Bar를 이용할 경우 Bar가 철재질로 구성되어 있으며 강성이 크기 때문에 진동의 감쇠 효과를 가져올 수 있었다. 차량의 진동을 보다 효과적으로 제어한다면 진동에 의한 노이즈를 줄일 수 있을 것이라 생각한다.

##### 고속 주행에서 발생하는 곡선 구간의 이탈

* 곡선구간을 빠르게 통과할 경우, 곡선 구간을 이탈하는 경우가 발생했다. 이를 Servo motor의 조향각과 P Gain과 D Gain의 조절을 통해 조절하려했으나 실패했다. 그리하여 차량의 구조를 분석했는데 무게중심이 정면에서 봤을 때 차량의 오른쪽에 위치해 있는 것을 확인할 수 있었다. 이는 차량의 무게에 큰 영향을 미치는 베터리가 오른쪽에 위치해 있었기 때문이었다. 즉, 무게중심이 오른쪽으로 치우쳐 있었기 때문에 곡선 구간을 고속으로 통과할 때 원심력에 의해 이탈하는 것을 확인할 수 있었다. 그리하여 Shock absorber의 탄성을 높이고 베터리의 위치를 최대한 중앙으로 위치시키고 고정시킴으로써 고속주행으로 곡선 구간을 통과할 수 있었다. 무게중심을 중심으로 위치시키고 낮추도록 각 구성부를 배치한다면 보다 빠른 속도로 곡선구간을 통과할 수 있을 것이다.


##### 초음파 센서 - Line의 양쪽에 위치한 계수기를 인식하는 문제

* 선행차량과의 거리가 떨어진 상태에서 SCC 차량이 주행하면서 Line 주위의 물체를 인식하고 멈추는 현상을 발견했다. 이는 초음파 센서가 Line 주위의 물체를 선행차량이라 잘못 인식하여 발생하는 문제인데, 실제 대회에서는 계수기가 이와 같은 문제를 야기할 수 있다고 생각했다. 이러한 문제를 해결하기 위해서는 초음파 센서를 차량의 중심에 하나만 배치하여 초음파 센서의 측정범위가 좁아지도록 하면 되나, 초음파 센서를 하나만 배치할 경우 곡선 구간에서 선행차량을 놓치는 문제를 야기하기 때문에 따라서 초음파 센서가 바닥에 위치한 계수기를 인식하지 않도록 하기 위해 약간의 각도를 주어 초음파 센서가 위로 향하도록 차량에 부착함으로써 개선할 수 있었다.

##### 모터 드라이버의 과열 현상

* 모터 드라이버의 경우 상당한 발열이 발생하는 것을 확인할 수 있었다. 방열판을 부착함으로써 열전달을 보다 효과적으로 할 수 있었으나 근본적인 대책이 되지 못했다. 자연대류를 통해 보다 효과적으로 열전달을 수행하기 위해 회로를 구성하거나 혹은 Fan을 통한 강제대류를 시킨다면 보다 효과적으로 열전달을 수행할 수 있을 것이라 생각한다.

##### 효과적인 제어를 하기 위한 PID Gain 선택 문제

* PID Control을 위한 각각의 PID Gain의 경우, 일반적으로 경험적으로 선택한다. 이는 매우 많은 시간 소요를 가져옴으로 효과적이지 못할 수 있다. 이러한 PID Gain을 찾기위한 경험적 방법을 보다 효과적으로 수행하기 위한 방법이 Ziegler-Nichols의 두 가지 방법은 이용하여 Simulation을 수행했다면, 보다 효과적으로 PID Gain을 찾을 수 있을 것이라 생각한다. Ziegler-Nichols가 제안한 두 가지 방법 중 첫 번째는 Gain을 0.25의 감소비를 갖는 폐루프 계단응답을 갖도록 설계하는 것과 두 번째는 임계민감도 방법이다. 지속적인 진동이 발생하는 임계 Gain과 임계 주기를 구하여 그보다 작은 값을 취하는 방법이다. 위의 두가지 방법을 통해 Gain을 찾았다면 보다 효율적으로 찾을 수 있을 것이라 생각한다.



### **Appendix - 부품 목록**

제조사  | 부품명   | 수량 | 사용 목적
---------|-----------|---------|-----------------
Any Vender | 74HC74 | 1 | 엔코더 회로
Any Vender | 74HC86 | 1 | 엔코더 회로
Any Vender | 74HC08 | 1 | 엔코더 회로
Any Vender | 74HC14 | 1 | 엔코더 회로
Autonics | E30S4-3000-3-V-5 | 1 | 엔코더
International Rectifier | IRF4905 | 2 | H-Bridge (P-MOS)
International Rectifier | IRF3205 | 2 | H-Bridge (N-MOS)
Any Vender | S9013-H | 2 | H-Bridge (NPN Transistor)
Any Vender | LM2567-5V | 1 | 전원부
Fairchild Semiconductor | LM7806CT | 1 | 전원부
Hitec | HS-7940TH | 1 | 조향부
Turnigy | Nano-tech 6000mAh 2S2P 65~130C LiPo | 1 | 배터리
OSRAM | SFH 300 FA - 3/4 | 8 | 수광부 적외선 센서
AUK Semiconductor | SI5312-H | 8 | 발광부 적외선 센서
Any Vender | ULN2803 | 1 | 발광부 회로
Devantech | SRF04 | 3 | 거리측정용 초음파 센서
KOMI | SR-4156K | 1 | 7-Segment
Any Vender | 5mm LED | 8 | LED
Any Vender | Switch | 6 | Switch

